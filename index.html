<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Production Tracking</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
  </head>
  <body>
    <h1>Production Tracking</h1>

    <form id="jobForm">
      <input type="text" id="serialNumber" placeholder="SL" required />
      <input type="text" id="item" placeholder="Item" required />
      <input type="number" id="quantity" placeholder="Quantity" required />
      <input type="date" id="jobDate" required />
      <input type="time" id="startTime" required />
      <input type="time" id="endTime" required />
      <button type="submit">Add Job</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>SL</th>
          <th>Item</th>
          <th>Quantity</th>
          <th>Date</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Total Time</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="jobTableBody"></tbody>
    </table>

    <button id="generatePDF">Production Completed</button>

    <script>
      document
        .getElementById("jobForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          let serialNumber = document.getElementById("serialNumber").value;
          let item = document.getElementById("item").value;
          let quantity = document.getElementById("quantity").value;
          let jobDate = document.getElementById("jobDate").value;
          let startTime = document.getElementById("startTime").value;
          let endTime = document.getElementById("endTime").value;

          let formattedDate = formatDate(jobDate);
          let formattedStartTime = formatTime(startTime);
          let formattedEndTime = formatTime(endTime);
          let totalTime = calculateTotalTime(startTime, endTime);

          let tableBody = document.getElementById("jobTableBody");
          let newRow = document.createElement("tr");

          newRow.innerHTML = `
                <td>${serialNumber}</td>
                <td>${item}</td>
                <td>${quantity}</td>
                <td>${formattedDate}</td>
                <td>${formattedStartTime}</td>
                <td>${formattedEndTime}</td>
                <td>${totalTime}</td>
                <td>
                    <button class="complete-btn">Completed</button>
                    <button class="delete-btn">Delete</button>
                </td>
            `;

          tableBody.appendChild(newRow);
          document.getElementById("jobForm").reset();
        });

      function formatDate(dateString) {
        let [year, month, day] = dateString.split("-");
        return `${day}-${month}-${year}`;
      }

      function formatTime(time) {
        let [hour, minute] = time.split(":");
        hour = parseInt(hour, 10);
        let period = hour >= 12 ? "PM" : "AM";
        hour = hour % 12 || 12;
        return `${hour}:${minute} ${period}`;
      }

      function calculateTotalTime(start, end) {
        let [startHour, startMinute] = start.split(":").map(Number);
        let [endHour, endMinute] = end.split(":").map(Number);

        let startDate = new Date(0, 0, 0, startHour, startMinute);
        let endDate = new Date(0, 0, 0, endHour, endMinute);

        let diff = (endDate - startDate) / (1000 * 60);
        if (diff < 0) return "Invalid Time";

        let hours = Math.floor(diff / 60);
        let minutes = diff % 60;

        return `${hours}h ${minutes}m`;
      }

      document
        .getElementById("jobTableBody")
        .addEventListener("click", function (event) {
          let row = event.target.closest("tr");

          if (event.target.classList.contains("delete-btn")) {
            row.remove();
          } else if (event.target.classList.contains("complete-btn")) {
            row.style.backgroundColor = "lightgreen";
          }
        });

      document
        .getElementById("generatePDF")
        .addEventListener("click", function () {
          let tableData = [];
          let rows = document.querySelectorAll("#jobTableBody tr");

          rows.forEach((row) => {
            let cells = row.querySelectorAll("td");
            let rowData = [];

            for (let i = 0; i < cells.length - 1; i++) {
              rowData.push(cells[i].innerText);
            }

            tableData.push(rowData);
          });

          let docDefinition = {
            content: [
              { text: "Daily Production Report", style: "header" },
              {
                text: `Date: ${new Date().toLocaleDateString("en-GB")}`,
                style: "subheader",
              },
              {
                table: {
                  headerRows: 1,
                  widths: ["auto", "*", "auto", "auto", "auto", "auto", "auto"],
                  body: [
                    [
                      "SL",
                      "Item",
                      "Quantity",
                      "Date",
                      "Start Time",
                      "End Time",
                      "Total Time",
                    ],
                    ...tableData,
                  ],
                },
              },
            ],
            styles: {
              header: { fontSize: 16, bold: true, margin: [0, 0, 0, 10] },
              subheader: { fontSize: 12, margin: [0, 0, 0, 10] },
            },
          };

          pdfMake
            .createPdf(docDefinition)
            .download(
              `Daily Production Report - ${new Date().toLocaleDateString(
                "en-GB"
              )}.pdf`
            );
        });
    </script>
  </body>
</html>
